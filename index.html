<!DOCTYPE html>

<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

```
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', sans-serif;
        background: #000000 !important;
        color: #ffffff;
        min-height: 100vh;
        padding: 20px;
        -webkit-font-smoothing: antialiased;
    }

    html {
        background: #000000 !important;
    }

    .container {
        max-width: 1600px;
        margin: 0 auto;
    }

    /* Header */
    header {
        text-align: center;
        margin-bottom: 40px;
        padding: 30px 0;
    }

    h1 {
        font-size: 42px;
        font-weight: 600;
        letter-spacing: -0.5px;
        color: #ffffff;
    }

    /* Desktop Layout - 3 Columns */
    .main-layout {
        display: grid;
        grid-template-columns: 250px 1fr 250px;
        gap: 20px;
        align-items: start;
    }

    /* Sidebars */
    .sidebar {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        padding: 20px;
        position: sticky;
        top: 20px;
    }

    .sidebar-section {
        margin-bottom: 30px;
    }

    .sidebar-section:last-child {
        margin-bottom: 0;
    }

    .sidebar-title {
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: rgba(255, 255, 255, 0.5);
        margin-bottom: 12px;
    }

    .sidebar-button {
        width: 100%;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.15);
        color: white;
        padding: 12px 16px;
        border-radius: 10px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
        margin-bottom: 8px;
        text-align: left;
    }

    .sidebar-button:hover {
        background: rgba(255, 255, 255, 0.12);
        transform: translateX(2px);
    }

    .sidebar-item {
        padding: 10px 12px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        margin-bottom: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.2s ease;
    }

    .sidebar-item:hover {
        background: rgba(255, 255, 255, 0.08);
    }

    .sidebar-item.active {
        background: rgba(255, 255, 255, 0.15);
        font-weight: 600;
    }

    .item-count {
        font-size: 12px;
        color: rgba(255, 255, 255, 0.6);
    }

    /* Main Content */
    .main-content {
        min-height: 400px;
    }

    .tasks-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 16px;
        margin-top: 20px;
    }

    /* Task Card */
    .task-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 16px;
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .task-card:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(255, 255, 255, 0.2);
    }

    .task-card.completed {
        opacity: 0.5;
    }

    .task-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
    }

    .task-checkbox {
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 6px;
        cursor: pointer;
        flex-shrink: 0;
        margin-right: 12px;
        transition: all 0.2s ease;
    }

    .task-checkbox.checked {
        background: white;
        border-color: white;
    }

    .task-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 8px;
        flex-grow: 1;
    }

    .task-category {
        display: inline-block;
        padding: 4px 10px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 6px;
        font-size: 12px;
        margin-bottom: 8px;
    }

    .task-deadline {
        font-size: 13px;
        color: rgba(255, 255, 255, 0.7);
        margin-bottom: 4px;
    }

    .task-time {
        font-size: 12px;
        color: rgba(255, 255, 255, 0.5);
        margin-bottom: 8px;
    }

    .task-description {
        font-size: 13px;
        color: rgba(255, 255, 255, 0.6);
        margin-top: 8px;
        line-height: 1.4;
    }

    .urgency-indicator {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
        margin-top: 8px;
    }

    .urgency-critical {
        background: rgba(255, 59, 48, 0.2);
        color: #ff3b30;
    }

    .urgency-urgent {
        background: rgba(255, 149, 0, 0.2);
        color: #ff9500;
    }

    .urgency-soon {
        background: rgba(255, 204, 0, 0.2);
        color: #ffcc00;
    }

    .urgency-relaxed {
        background: rgba(52, 199, 89, 0.2);
        color: #34c759;
    }

    .task-menu {
        padding: 8px;
        cursor: pointer;
        border-radius: 6px;
        transition: all 0.2s ease;
    }

    .task-menu:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    /* Subtasks */
    .subtasks {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .subtask-item {
        display: flex;
        align-items: center;
        padding: 6px 0;
        font-size: 13px;
        color: rgba(255, 255, 255, 0.7);
    }

    .subtask-checkbox {
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 4px;
        margin-right: 8px;
        cursor: pointer;
    }

    .subtask-checkbox.checked {
        background: white;
    }

    /* Buttons */
    .btn {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        padding: 12px 24px;
        border-radius: 12px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .btn:hover {
        background: rgba(255, 255, 255, 0.15);
    }

    .btn-primary {
        background: white;
        color: black;
    }

    .btn-primary:hover {
        background: rgba(255, 255, 255, 0.9);
    }

    /* Modal */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(10px);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .modal.active {
        display: flex;
    }

    .modal-content {
        background: #1a1a1a;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        padding: 30px;
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-header {
        font-size: 24px;
        font-weight: 600;
        margin-bottom: 20px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 8px;
        color: rgba(255, 255, 255, 0.8);
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        padding: 12px;
        border-radius: 10px;
        font-size: 14px;
        font-family: inherit;
    }

    .form-group textarea {
        min-height: 80px;
        resize: vertical;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: rgba(255, 255, 255, 0.4);
        background: rgba(255, 255, 255, 0.08);
    }

    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 8px;
    }

    .checkbox-group input[type="checkbox"] {
        width: 18px;
        height: 18px;
    }

    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
    }

    .weekdays {
        display: flex;
        gap: 8px;
        margin-top: 8px;
        flex-wrap: wrap;
    }

    .weekday-btn {
        padding: 8px 12px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.2s ease;
    }

    .weekday-btn.active {
        background: white;
        color: black;
    }

    .modal-actions {
        display: flex;
        gap: 12px;
        margin-top: 24px;
    }

    .modal-actions button {
        flex: 1;
    }

    /* Template List */
    .template-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .template-item {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 16px;
    }

    .template-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 8px;
    }

    .template-title {
        font-weight: 600;
        font-size: 16px;
    }

    .template-meta {
        font-size: 12px;
        color: rgba(255, 255, 255, 0.6);
    }

    .template-actions {
        display: flex;
        gap: 8px;
        margin-top: 12px;
    }

    .template-actions button {
        padding: 8px 16px;
        font-size: 13px;
    }

    /* Responsive */
    @media (max-width: 1200px) {
        .main-layout {
            grid-template-columns: 1fr;
        }

        .sidebar {
            position: relative;
            top: 0;
            margin-bottom: 20px;
        }
    }

    @media (max-width: 768px) {
        .tasks-grid {
            grid-template-columns: 1fr;
        }

        body {
            padding: 10px;
        }

        header {
            margin-bottom: 20px;
            padding: 20px 0;
        }

        h1 {
            font-size: 32px;
        }

        .sidebar {
            padding: 16px;
        }
    }

    /* Hidden file input */
    #importFile {
        display: none;
    }
</style>
```

</head>
<body>
    <div class="container">
        <header>
            <h1>Aufgaben</h1>
        </header>

```
    <div class="main-layout">
        <!-- Left Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title">Aktionen</div>
                <button class="sidebar-button" onclick="openTaskModal()">+ Neue Aufgabe</button>
                <button class="sidebar-button" onclick="openTemplateModal()">+ Neues Template</button>
                <button class="sidebar-button" onclick="openTemplateManager()">Templates verwalten</button>
                <button class="sidebar-button" onclick="exportData()">Exportieren</button>
                <button class="sidebar-button" onclick="document.getElementById('importFile').click()">Importieren</button>
                <input type="file" id="importFile" accept=".json" onchange="importData(event)">
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Ansicht</div>
                <div class="sidebar-item active" onclick="filterView('all')">Alle Aufgaben</div>
                <div class="sidebar-item" onclick="filterView('active')">Nur Aktive</div>
                <div class="sidebar-item" onclick="filterView('deadline')">Nach Deadline</div>
                <div class="sidebar-item" onclick="filterView('category')">Nach Kategorie</div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="tasks-grid" id="tasksGrid"></div>
        </main>

        <!-- Right Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title">Kategorien</div>
                <div id="categoriesList"></div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Statistiken</div>
                <div class="sidebar-item" onclick="filterUrgency('open')">
                    <span>Offen</span>
                    <span class="item-count" id="openCount">0</span>
                </div>
                <div class="sidebar-item" onclick="filterUrgency('completed')">
                    <span>Erledigt</span>
                    <span class="item-count" id="completedCount">0</span>
                </div>
                <div class="sidebar-item" onclick="filterUrgency('critical')">
                    <span>ðŸ”´ Kritisch</span>
                    <span class="item-count" id="criticalCount">0</span>
                </div>
                <div class="sidebar-item" onclick="filterUrgency('urgent')">
                    <span>ðŸŸ  Dringend</span>
                    <span class="item-count" id="urgentCount">0</span>
                </div>
                <div class="sidebar-item" onclick="filterUrgency('soon')">
                    <span>ðŸŸ¡ Bald</span>
                    <span class="item-count" id="soonCount">0</span>
                </div>
                <div class="sidebar-item" onclick="filterUrgency('relaxed')">
                    <span>ðŸŸ¢ Entspannt</span>
                    <span class="item-count" id="relaxedCount">0</span>
                </div>
            </div>
        </aside>
    </div>
</div>

<!-- Task Modal -->
<div id="taskModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">Neue Aufgabe</div>
        <form id="taskForm" onsubmit="saveTask(event)">
            <div class="form-group">
                <label for="taskTitle">Titel *</label>
                <input type="text" id="taskTitle" required>
            </div>

            <div class="form-group">
                <label for="taskCategory">Kategorie</label>
                <select id="taskCategory">
                    <option value="Privat">Privat</option>
                    <option value="Arbeit">Arbeit</option>
                    <option value="Studium">Studium</option>
                </select>
            </div>

            <div class="form-group">
                <label for="taskDeadline">Deadline</label>
                <input type="date" id="taskDeadline">
            </div>

            <div class="form-group">
                <label for="taskStartTime">Startzeit</label>
                <input type="time" id="taskStartTime">
            </div>

            <div class="form-group">
                <label for="taskEndTime">Endzeit</label>
                <input type="time" id="taskEndTime">
            </div>

            <div class="form-group">
                <label for="taskDuration">Erwartete Bearbeitungszeit (Tage)</label>
                <input type="number" id="taskDuration" min="0" step="0.5" placeholder="z.B. 2.5">
            </div>

            <div class="form-group">
                <label for="taskDescription">Beschreibung</label>
                <textarea id="taskDescription"></textarea>
            </div>

            <div class="form-group">
                <div class="checkbox-label">
                    <input type="checkbox" id="taskRepeat" onchange="toggleRepeatOptions()">
                    <label for="taskRepeat">Wiederholen</label>
                </div>
            </div>

            <div id="repeatOptions" style="display: none;">
                <div class="form-group">
                    <label for="repeatInterval">Intervall</label>
                    <select id="repeatInterval">
                        <option value="1">Jede Woche</option>
                        <option value="2">Alle 2 Wochen</option>
                        <option value="3">Alle 3 Wochen</option>
                        <option value="4">Alle 4 Wochen</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Wochentage</label>
                    <div class="weekdays">
                        <button type="button" class="weekday-btn" data-day="1" onclick="toggleWeekday(this)">Mo</button>
                        <button type="button" class="weekday-btn" data-day="2" onclick="toggleWeekday(this)">Di</button>
                        <button type="button" class="weekday-btn" data-day="3" onclick="toggleWeekday(this)">Mi</button>
                        <button type="button" class="weekday-btn" data-day="4" onclick="toggleWeekday(this)">Do</button>
                        <button type="button" class="weekday-btn" data-day="5" onclick="toggleWeekday(this)">Fr</button>
                        <button type="button" class="weekday-btn" data-day="6" onclick="toggleWeekday(this)">Sa</button>
                        <button type="button" class="weekday-btn" data-day="0" onclick="toggleWeekday(this)">So</button>
                    </div>
                </div>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn" onclick="closeTaskModal()">Abbrechen</button>
                <button type="submit" class="btn btn-primary">Speichern</button>
            </div>
        </form>
    </div>
</div>

<!-- Template Modal -->
<div id="templateModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">Neues Template</div>
        <form id="templateForm" onsubmit="saveTemplate(event)">
            <div class="form-group">
                <label for="templateTitle">Titel *</label>
                <input type="text" id="templateTitle" required>
            </div>

            <div class="form-group">
                <label for="templateCategory">Kategorie</label>
                <select id="templateCategory">
                    <option value="Privat">Privat</option>
                    <option value="Arbeit">Arbeit</option>
                    <option value="Studium">Studium</option>
                </select>
            </div>

            <div class="form-group">
                <label for="templateDescription">Beschreibung</label>
                <textarea id="templateDescription"></textarea>
            </div>

            <div class="form-group">
                <label for="templateDuration">Erwartete Bearbeitungszeit (Tage)</label>
                <input type="number" id="templateDuration" min="0" step="0.5" placeholder="Optional">
            </div>

            <div class="form-group">
                <label>Unteraufgaben</label>
                <div id="templateSubtasks"></div>
                <button type="button" class="btn" onclick="addTemplateSubtask()" style="margin-top: 8px;">+ Unteraufgabe</button>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn" onclick="closeTemplateModal()">Abbrechen</button>
                <button type="submit" class="btn btn-primary">Speichern</button>
            </div>
        </form>
    </div>
</div>

<!-- Template Manager Modal -->
<div id="templateManagerModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">Templates verwalten</div>
        <div class="template-list" id="templateList"></div>
        <div class="modal-actions">
            <button type="button" class="btn btn-primary" onclick="closeTemplateManager()">SchlieÃŸen</button>
        </div>
    </div>
</div>

<!-- Subtask Modal -->
<div id="subtaskModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">Unteraufgaben</div>
        <div id="subtasksList"></div>
        <button type="button" class="btn" onclick="addSubtask()">+ Unteraufgabe</button>
        <div class="modal-actions">
            <button type="button" class="btn btn-primary" onclick="closeSubtaskModal()">Fertig</button>
        </div>
    </div>
</div>

<script>
    // Data Structure
    let tasks = [];
    let templates = [];
    let categories = ['Privat', 'Arbeit', 'Studium'];
    let currentFilter = 'all';
    let currentUrgencyFilter = null;
    let currentCategoryFilter = null;
    let editingTaskId = null;
    let currentSubtaskParent = null;

    // Load data from localStorage
    function loadData() {
        const saved = localStorage.getItem('todoAppData');
        if (saved) {
            const data = JSON.parse(saved);
            tasks = data.tasks || [];
            templates = data.templates || [];
            categories = data.categories || ['Privat', 'Arbeit', 'Studium'];
        }
    }

    // Save data to localStorage
    function saveData() {
        const data = {
            tasks,
            templates,
            categories
        };
        localStorage.setItem('todoAppData', JSON.stringify(data));
    }

    // Export data
    function exportData() {
        const data = {
            tasks,
            templates,
            categories,
            exportDate: new Date().toISOString()
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `todo-backup-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
    }

    // Import data
    function importData(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                
                // Validate and import all data including categories
                if (data.tasks) tasks = data.tasks;
                if (data.templates) templates = data.templates;
                if (data.categories) categories = data.categories;
                
                saveData();
                renderTasks();
                updateStats();
                updateCategories();
                alert('Daten erfolgreich importiert! Alle Aufgaben, Templates und Kategorien wurden Ã¼bertragen.');
            } catch (err) {
                alert('Fehler beim Importieren: UngÃ¼ltige Datei');
            }
        };
        reader.readAsText(file);
        
        // Reset file input
        event.target.value = '';
    }

    // Calculate urgency
    function calculateUrgency(task) {
        if (!task.deadline || task.completed) return null;

        const now = new Date();
        const deadline = new Date(task.deadline);
        const daysUntil = Math.ceil((deadline - now) / (1000 * 60 * 60 * 24));
        const duration = task.duration || 0;
        const buffer = daysUntil - duration;

        if (buffer <= 1) return 'critical';
        if (buffer <= 3) return 'urgent';
        if (buffer <= 7) return 'soon';
        return 'relaxed';
    }

    // Get urgency label
    function getUrgencyLabel(urgency) {
        const labels = {
            critical: 'Kritisch',
            urgent: 'Dringend',
            soon: 'Bald',
            relaxed: 'Entspannt'
        };
        return labels[urgency] || '';
    }

    // Render tasks
    function renderTasks() {
        const grid = document.getElementById('tasksGrid');
        let filteredTasks = [...tasks];

        // Apply filters
        if (currentFilter === 'active') {
            filteredTasks = filteredTasks.filter(t => !t.completed && !t.parentId);
        } else {
            filteredTasks = filteredTasks.filter(t => !t.parentId);
        }

        if (currentUrgencyFilter === 'open') {
            filteredTasks = filteredTasks.filter(t => !t.completed);
        } else if (currentUrgencyFilter === 'completed') {
            filteredTasks = filteredTasks.filter(t => t.completed);
        } else if (currentUrgencyFilter) {
            filteredTasks = filteredTasks.filter(t => {
                const urgency = calculateUrgency(t);
                return urgency === currentUrgencyFilter;
            });
        }

        if (currentCategoryFilter) {
            filteredTasks = filteredTasks.filter(t => t.category === currentCategoryFilter);
        }

        // Sort by deadline
        filteredTasks.sort((a, b) => {
            if (a.completed && !b.completed) return 1;
            if (!a.completed && b.completed) return -1;
            if (!a.deadline && !b.deadline) return 0;
            if (!a.deadline) return 1;
            if (!b.deadline) return -1;
            return new Date(a.deadline) - new Date(b.deadline);
        });

        if (filteredTasks.length === 0) {
            grid.innerHTML = `
                <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px; color: rgba(255,255,255,0.5);">
                    <div style="font-size: 48px; margin-bottom: 16px;">ðŸ“‹</div>
                    <div style="font-size: 18px; font-weight: 500; margin-bottom: 8px;">Keine Aufgaben</div>
                    <div style="font-size: 14px;">Erstelle deine erste Aufgabe mit dem + Button</div>
                </div>
            `;
            updateStats();
            return;
        }

        grid.innerHTML = filteredTasks.map(task => {
            const urgency = calculateUrgency(task);
            const subtasks = tasks.filter(t => t.parentId === task.id);
            
            return `
                <div class="task-card ${task.completed ? 'completed' : ''}">
                    <div class="task-header">
                        <div style="display: flex; align-items: flex-start; flex-grow: 1;">
                            <div class="task-checkbox ${task.completed ? 'checked' : ''}" 
                                 onclick="toggleTask('${task.id}')"></div>
                            <div style="flex-grow: 1;">
                                <div class="task-title">${task.title}</div>
                                ${task.category ? `<div class="task-category">${task.category}</div>` : ''}
                                ${task.deadline ? `<div class="task-deadline">ðŸ“… ${formatDate(task.deadline)}</div>` : ''}
                                ${task.startTime || task.endTime ? `<div class="task-time">${task.startTime || ''} ${task.startTime && task.endTime ? 'â€“' : ''} ${task.endTime || ''}</div>` : ''}
                                ${task.description ? `<div class="task-description">${task.description}</div>` : ''}
                                ${urgency ? `<div class="urgency-indicator urgency-${urgency}">${getUrgencyLabel(urgency)}</div>` : ''}
                            </div>
                        </div>
                        <div class="task-menu" onclick="openTaskMenu('${task.id}')">â‹¯</div>
                    </div>
                    ${subtasks.length > 0 ? `
                        <div class="subtasks">
                            ${subtasks.map(sub => `
                                <div class="subtask-item">
                                    <div class="subtask-checkbox ${sub.completed ? 'checked' : ''}" 
                                         onclick="toggleTask('${sub.id}')"></div>
                                    <span style="${sub.completed ? 'text-decoration: line-through; opacity: 0.6;' : ''}">${sub.title}</span>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        }).join('');

        updateStats();
    }

    // Format date
    function formatDate(dateString) {
        const date = new Date(dateString);
        const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
        return date.toLocaleDateString('de-DE', options);
    }

    // Update statistics
    function updateStats() {
        const openTasks = tasks.filter(t => !t.completed && !t.parentId);
        const completedTasks = tasks.filter(t => t.completed && !t.parentId);
        
        document.getElementById('openCount').textContent = openTasks.length;
        document.getElementById('completedCount').textContent = completedTasks.length;

        let critical = 0, urgent = 0, soon = 0, relaxed = 0;
        openTasks.forEach(task => {
            const urgency = calculateUrgency(task);
            if (urgency === 'critical') critical++;
            else if (urgency === 'urgent') urgent++;
            else if (urgency === 'soon') soon++;
            else if (urgency === 'relaxed') relaxed++;
        });

        document.getElementById('criticalCount').textContent = critical;
        document.getElementById('urgentCount').textContent = urgent;
        document.getElementById('soonCount').textContent = soon;
        document.getElementById('relaxedCount').textContent = relaxed;
    }

    // Update categories list
    function updateCategories() {
        const list = document.getElementById('categoriesList');
        const categoryTaskCounts = {};
        
        categories.forEach(cat => {
            categoryTaskCounts[cat] = tasks.filter(t => t.category === cat && !t.completed && !t.parentId).length;
        });

        list.innerHTML = categories.map(cat => `
            <div class="sidebar-item ${currentCategoryFilter === cat ? 'active' : ''}" 
                 onclick="filterCategory('${cat}')">
                <span>${cat}</span>
                <span class="item-count">${categoryTaskCounts[cat]}</span>
            </div>
        `).join('');
    }

    // Filter functions
    function filterView(view) {
        currentFilter = view;
        currentUrgencyFilter = null;
        currentCategoryFilter = null;
        
        // Update active state
        document.querySelectorAll('.sidebar-item').forEach(item => {
            item.classList.remove('active');
        });
        event.target.classList.add('active');
        
        renderTasks();
    }

    function filterUrgency(urgency) {
        currentUrgencyFilter = urgency;
        currentCategoryFilter = null;
        renderTasks();
    }

    function filterCategory(category) {
        currentCategoryFilter = currentCategoryFilter === category ? null : category;
        currentUrgencyFilter = null;
        updateCategories();
        renderTasks();
    }

    // Toggle task completion
    function toggleTask(taskId) {
        const task = tasks.find(t => t.id === taskId);
        if (task) {
            task.completed = !task.completed;
            saveData();
            renderTasks();
        }
    }

    // Task Modal
    function openTaskModal(taskId = null) {
        editingTaskId = taskId;
        const modal = document.getElementById('taskModal');
        
        if (taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                document.getElementById('taskTitle').value = task.title;
                document.getElementById('taskCategory').value = task.category || '';
                document.getElementById('taskDeadline').value = task.deadline || '';
                document.getElementById('taskStartTime').value = task.startTime || '';
                document.getElementById('taskEndTime').value = task.endTime || '';
                document.getElementById('taskDuration').value = task.duration || '';
                document.getElementById('taskDescription').value = task.description || '';
                document.getElementById('taskRepeat').checked = task.repeat || false;
                
                if (task.repeat) {
                    document.getElementById('repeatOptions').style.display = 'block';
                    document.getElementById('repeatInterval').value = task.repeatInterval || '1';
                    
                    // Set weekdays
                    document.querySelectorAll('.weekday-btn').forEach(btn => {
                        btn.classList.remove('active');
                        if (task.repeatDays && task.repeatDays.includes(parseInt(btn.dataset.day))) {
                            btn.classList.add('active');
                        }
                    });
                }
            }
        } else {
            document.getElementById('taskForm').reset();
            document.getElementById('repeatOptions').style.display = 'none';
            document.querySelectorAll('.weekday-btn').forEach(btn => btn.classList.remove('active'));
        }
        
        modal.classList.add('active');
    }

    function closeTaskModal() {
        document.getElementById('taskModal').classList.remove('active');
        editingTaskId = null;
    }

    function toggleRepeatOptions() {
        const checked = document.getElementById('taskRepeat').checked;
        document.getElementById('repeatOptions').style.display = checked ? 'block' : 'none';
    }

    function toggleWeekday(button) {
        button.classList.toggle('active');
    }

    function saveTask(event) {
        event.preventDefault();
        
        const title = document.getElementById('taskTitle').value;
        const category = document.getElementById('taskCategory').value;
        const deadline = document.getElementById('taskDeadline').value;
        const startTime = document.getElementById('taskStartTime').value;
        const endTime = document.getElementById('taskEndTime').value;
        const duration = parseFloat(document.getElementById('taskDuration').value) || 0;
        const description = document.getElementById('taskDescription').value;
        const repeat = document.getElementById('taskRepeat').checked;
        
        let repeatData = {};
        if (repeat) {
            const repeatInterval = document.getElementById('repeatInterval').value;
            const repeatDays = Array.from(document.querySelectorAll('.weekday-btn.active'))
                .map(btn => parseInt(btn.dataset.day));
            
            repeatData = {
                repeat: true,
                repeatInterval,
                repeatDays
            };
        }

        if (editingTaskId) {
            // Update existing task
            const task = tasks.find(t => t.id === editingTaskId);
            if (task) {
                Object.assign(task, {
                    title,
                    category,
                    deadline,
                    startTime,
                    endTime,
                    duration,
                    description,
                    ...repeatData
                });
            }
        } else {
            // Create new task
            const task = {
                id: Date.now().toString(),
                title,
                category,
                deadline,
                startTime,
                endTime,
                duration,
                description,
                completed: false,
                createdAt: new Date().toISOString(),
                ...repeatData
            };
            tasks.push(task);
        }

        saveData();
        renderTasks();
        updateCategories();
        closeTaskModal();
    }

    // Template Modal
    function openTemplateModal() {
        document.getElementById('templateModal').classList.add('active');
        document.getElementById('templateSubtasks').innerHTML = '';
    }

    function closeTemplateModal() {
        document.getElementById('templateModal').classList.remove('active');
        document.getElementById('templateForm').reset();
    }

    function addTemplateSubtask() {
        const container = document.getElementById('templateSubtasks');
        const index = container.children.length;
        
        const div = document.createElement('div');
        div.className = 'form-group';
        div.innerHTML = `
            <input type="text" placeholder="Unteraufgabe ${index + 1}" class="template-subtask">
        `;
        container.appendChild(div);
    }

    function saveTemplate(event) {
        event.preventDefault();
        
        const title = document.getElementById('templateTitle').value;
        const category = document.getElementById('templateCategory').value;
        const description = document.getElementById('templateDescription').value;
        const duration = parseFloat(document.getElementById('templateDuration').value) || 0;
        
        const subtaskInputs = document.querySelectorAll('.template-subtask');
        const subtasks = Array.from(subtaskInputs)
            .map(input => input.value.trim())
            .filter(value => value !== '');

        const template = {
            id: Date.now().toString(),
            title,
            category,
            description,
            duration,
            subtasks,
            createdAt: new Date().toISOString()
        };

        templates.push(template);
        saveData();
        closeTemplateModal();
        alert('Template gespeichert!');
    }

    // Template Manager
    function openTemplateManager() {
        const modal = document.getElementById('templateManagerModal');
        const list = document.getElementById('templateList');
        
        list.innerHTML = templates.map(template => `
            <div class="template-item">
                <div class="template-header">
                    <div>
                        <div class="template-title">${template.title}</div>
                        <div class="template-meta">${template.category} â€¢ ${template.subtasks.length} Unteraufgaben</div>
                    </div>
                </div>
                ${template.description ? `<div class="task-description">${template.description}</div>` : ''}
                <div class="template-actions">
                    <button class="btn" onclick="loadTemplate('${template.id}')">Laden</button>
                    <button class="btn" onclick="deleteTemplate('${template.id}')">LÃ¶schen</button>
                </div>
            </div>
        `).join('');
        
        modal.classList.add('active');
    }

    function closeTemplateManager() {
        document.getElementById('templateManagerModal').classList.remove('active');
    }

    function loadTemplate(templateId) {
        const template = templates.find(t => t.id === templateId);
        if (!template) return;

        const deadline = prompt('Deadline fÃ¼r diese Aufgabe (YYYY-MM-DD):');
        if (!deadline) return;

        // Create main task
        const mainTask = {
            id: Date.now().toString(),
            title: template.title,
            category: template.category,
            description: template.description,
            deadline,
            duration: template.duration,
            completed: false,
            createdAt: new Date().toISOString()
        };
        tasks.push(mainTask);

        // Create subtasks
        template.subtasks.forEach((subtaskTitle, index) => {
            const subtask = {
                id: `${Date.now()}-${index}`,
                parentId: mainTask.id,
                title: subtaskTitle,
                completed: false,
                createdAt: new Date().toISOString()
            };
            tasks.push(subtask);
        });

        saveData();
        renderTasks();
        updateCategories();
        closeTemplateManager();
    }

    function deleteTemplate(templateId) {
        if (!confirm('Template wirklich lÃ¶schen?')) return;
        
        templates = templates.filter(t => t.id !== templateId);
        saveData();
        openTemplateManager(); // Refresh the list
    }

    // Task Menu
    function openTaskMenu(taskId) {
        const actions = [
            'Bearbeiten',
            'Unteraufgaben',
            'LÃ¶schen'
        ];

        const choice = prompt(`Aktion fÃ¼r Aufgabe:\n${actions.map((a, i) => `${i + 1}. ${a}`).join('\n')}\n\nWÃ¤hle eine Nummer:`);
        
        if (choice === '1') {
            openTaskModal(taskId);
        } else if (choice === '2') {
            openSubtaskModal(taskId);
        } else if (choice === '3') {
            deleteTask(taskId);
        }
    }

    function deleteTask(taskId) {
        if (!confirm('Aufgabe wirklich lÃ¶schen?')) return;
        
        // Delete task and all subtasks
        tasks = tasks.filter(t => t.id !== taskId && t.parentId !== taskId);
        saveData();
        renderTasks();
        updateCategories();
    }

    // Subtask Modal
    function openSubtaskModal(taskId) {
        currentSubtaskParent = taskId;
        const modal = document.getElementById('subtaskModal');
        const list = document.getElementById('subtasksList');
        
        const subtasks = tasks.filter(t => t.parentId === taskId);
        
        list.innerHTML = subtasks.map(sub => `
            <div class="subtask-item">
                <div class="subtask-checkbox ${sub.completed ? 'checked' : ''}" 
                     onclick="toggleTask('${sub.id}')"></div>
                <span style="${sub.completed ? 'text-decoration: line-through; opacity: 0.6;' : ''}">${sub.title}</span>
            </div>
        `).join('');
        
        modal.classList.add('active');
    }

    function closeSubtaskModal() {
        document.getElementById('subtaskModal').classList.remove('active');
        currentSubtaskParent = null;
        renderTasks();
    }

    function addSubtask() {
        if (!currentSubtaskParent) return;
        
        const title = prompt('Titel der Unteraufgabe:');
        if (!title) return;

        const subtask = {
            id: `${Date.now()}`,
            parentId: currentSubtaskParent,
            title,
            completed: false,
            createdAt: new Date().toISOString()
        };

        tasks.push(subtask);
        saveData();
        openSubtaskModal(currentSubtaskParent); // Refresh
    }

    // Initialize
    loadData();
    renderTasks();
    updateCategories();
</script>
```

</body>
</html>
